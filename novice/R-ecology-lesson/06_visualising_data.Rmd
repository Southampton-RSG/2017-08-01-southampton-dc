---
title: "Data visualisation" 
author: "Alistair Bailey"
minutes: 60
---

```{r, echo=FALSE, purl=FALSE,message=FALSE}
knitr::opts_chunk$set(results='hide', fig.path='img/r-lesson-')
```

```{r, echo=FALSE,eval=FALSE}
```{r,purl=FALSE,echo=FALSE}

# Create levels for rodent_type
# rodent_type_levels <- c("Kangeroo Rat", "Granivore")
# 
# # Convert to factor
# surveys_subset$rodent_type <- factor(surveys_sub$rodent_type, 
#                                   levels = rodent_type_levels)
# 
# plot_type_levels <- c("Long-term Krat Exclosure","Control")
# 
# surveys_sub$plot_type <- factor(surveys_sub$plot_type, 
#                                   levels = plot_type_levels)
# 
# glimpse(surveys_subset)


# ggplot(data = by_quarter,aes(x=quarter,y=captures,colour=plot_type)) + 
#   geom_line() +
#   geom_point() + 
#   facet_grid(~ rodent_type) +
#   scale_x_continuous(breaks = seq(1977,1991,1))

# ggplot(data= by_quarter) +
#   geom_boxplot(
#     mapping = aes(x = rodent_type, y = captures, fill = plot_type)) +
#   xlab("Plot type") +
#   ylab("Number of captures") +
#   ggtitle("Monthly captures of rodents between 1977 and 1990") +
#   theme_bw()


# by_month_genus <- surveys_subset %>% 
#   group_by(genus,date,plot_type) %>% 
#    summarise(captures = n()/3) 

# by_month_mean <- by_month_genus %>% group_by(genus,plot_type) %>% 
#   summarise(mean_captures = mean(captures))
# 
# # Orders the rodents alphabetically
# ggplot(by_month_mean, aes(x = mean_captures,y=genus)) +
#   geom_point() + facet_grid(~ plot_type)
# 
# # Orders the rodents according to number of captures
# ggplot(by_month_mean, 
#        aes(x = mean_captures, y = fct_reorder(genus,mean_captures))) + 
#   geom_point() + facet_grid(~ plot_type)


# Load the tidyverse set of packages -------------------------------------------
library(tidyverse)
library(forcats)
surveys <- read_csv('data/portal_data_joined.csv')
# Q: Which plots do we need for this analysis?
exp_plots <- c("Control",
               "Long-term Krat Exclosure",  
               "Short-term Krat Exclosure")

# Q: Which species do we need for this analysis?
# Use: https://github.com/weecology/PortalData/blob/master/Rodents/Portal_rodent_species.csv for codes.

# Kangeroo Rats:
# DM 	Dipodomys merriami 	Rodent 	Merriam's kangaroo rat
# DO 	Dipodomys ordii 	Rodent 	Ord's kangaroo rat
# DS 	Dipodomys spectabilis 	Rodent 	Banner-tailed kangaroo rat

# Granivores:
# PP 	Chaetodipus penicillatus 	Rodent 	Desert pocket mouse
# PF 	Perognathus flavus 	Rodent 	Silky pocket mouse
# PE 	Peromyscus eremicus 	Rodent 	Cactus mouse
# PM 	Peromyscus maniculatus 	Rodent 	Deer Mouse
# RM 	Reithrodontomys megalotis 	Rodent 	Western harvest mouse

# Grasshopper mouse:
# OX 	Onychomys sp. 	Rodent 	Grasshopper mouse

# List of species_id
rodents <- c("DM","DO","DS","PP","PF","PE","PM","RM","OX")

# Let's get filter the data we need:
surveys_sub <- surveys %>% 
  filter(species_id != "",            # remove missing species_id
         !is.na(weight),              # remove missing weight
         !is.na(hindfoot_length),     # remove missing hindfoot_length
         sex != "",                   # remove missing sex
         year <= 1991,                # Subset time period 1977 to 1991
         plot_type %in% exp_plots,    # Subset the plots used in the paper
         species_id %in% rodents)

# Let's turn the genus,species and plot_types into factors.
# Then we can group them accordingly.

# We have three groups we want: the Kangeroo Rats, the smaller granivores,
# and the grasshopper mouse.
surveys_sub <- surveys_sub %>% 
  mutate(genus = fct_collapse(genus,
                                "Kangeroo Rat" = "Dipodomys",
                                "Granivore" = c("Perognathus",
                                                "Peromyscus",
                                                "Chaetodipus",
                                                "Reithrodontomys"),
                                "Grasshopper mouse"= "Onychomys")) %>% 
  mutate(plot_type = as.factor(plot_type)) %>% 
  mutate(species = as.factor(species))
```

------------

> ### Learning Objectives
>
> By the end of this lesson the learner will:
>
> * Modify the aesthetics of an existing ggplot plot (including axis labels and color).
> * Build complex and customized plots from data in a dataframe.

--------------

# Visualisation with ggplot2 

This lesson will take the tidy data and create plots 

THE CODE BELOW IS A PLACEHOLDER FOR THE LESSON.

```{r, purl=FALSE}
# Plot the effects of Kangeroo exclosure on the other species
by_month <- group_by(surveys_sub,year,month,genus,plot_type)
surveys_sum <- summarise(by_month,count = n())

ggplot(data = surveys_sum,aes(x=year,y=count,colour=plot_type)) + geom_line() + facet_wrap(~ genus)
```
```{r,purl=FALSE}
by_species <- group_by(surveys_sub,species,plot_type) %>% 
  filter(genus == "Granivore")
species_sum <- summarise(by_species,count = n())

ggplot(data= species_sum) +
  geom_bar(
    mapping = aes(x = plot_type, y = count, fill = plot_type),
    position = "dodge",
    stat = "identity"
  ) +
  facet_wrap( ~ species)
```

```