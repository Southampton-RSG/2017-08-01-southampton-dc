<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Alistair Bailey" />


<title>Transforming data</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="01_R_and_Rstudio.html">R and RStudio</a>
</li>
<li>
  <a href="02_intro_to_R.html">Getting started</a>
</li>
<li>
  <a href="04_import_and_inspect.html">Importing data</a>
</li>
<li>
  <a href="05_transforming_data.html">Transforming data</a>
</li>
<li>
  <a href="06_visualising_data.html">Visualising data</a>
</li>
<li>
  <a href="07_summary_of_ecology_data.html">Communication</a>
</li>
<li>
  <a href="03_ecology_data_overview.html">Rodent Survey Overview</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/datacarpentry/R-ecology-lesson">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Transforming data</h1>
<h4 class="author"><em>Alistair Bailey</em></h4>

</div>


<hr />
<blockquote>
<h3 id="learning-objectives">Learning Objectives</h3>
<p>By the end of this lesson the learner will have been introduced the key verbs of the <code>dplyr</code> package needed to transform data into new forms. They will be able to:</p>
<ul>
<li>Filter rows with <code>filter()</code></li>
<li>Select columns with <code>select()</code></li>
<li>Add new variables with <code>mutate()</code></li>
<li>Create grouped summaries with <code>group_by</code> and <code>summarise()</code></li>
</ul>
<p>The learner will also be introduced to piping operations and working with dates along the way.</p>
</blockquote>
<hr />
<div style="text-align: center; margin-top: 30px; margin-bottom: 30px;">
<div class="figure">
<img src="img/data_workflow_trans.png" />

</div>
</div>
<div id="motivation" class="section level2">
<h2>Motivation</h2>
<p>Data rarely comes in the form we need it in, hence we need to transform it.</p>
<p>In this lesson we’ll transform data using another tidyverse package <code>dplyr</code> to:</p>
<ul>
<li>change the focus. For example, filtering data for (observations) rows or selecting (variables) columns of interest.</li>
<li>create new variables that are functions of existing variables. For example, transforming separate day, month and year variables into a single data variable.</li>
<li>calculate summarised data such as observations per three months.</li>
</ul>
<p>Often these operations can be combined, known as piping, which is very powerful and convenient.</p>
<p>Our goal is to reproduce the analysis of the 1994 Heske et. al. paper is that there is evidence that kangaroo rats compete directly with four other rodent species, generating a similar figure to the one below, to confirm their observations.</p>
<p>Concretely, we are going to look at the effect of kangaroo rat exclusion on the populations of smaller granivores in two 0.25 hectare plots versus two plots where kangaroo rats were allowed access.</p>
<p>Panels A and B shows the number of captures of threes species of kangaroo rats and five species of smaller granivore rodents over a period from 1977 to 1990. Panel A shows the populations when the eight species were left to compete for resources and Panel B shows the effect of excluding the kangaroo Rats.</p>
<p>For simplicity we’re going to ignore Panel C, which examines grasshopper rats, and only</p>
<div class="figure">
<img src="./img/HeskeBrown&amp;Mistry1994E_Fig_1.png" alt="Figure 1 from Heske et. al., 1994" />
<p class="caption">Figure 1 from Heske et. al., 1994</p>
</div>
</div>
<div id="filtering-observations" class="section level2">
<h2>Filtering observations</h2>
<p>The first verb to consider is <code>filter</code> which enables us to subset observations based on their value.</p>
<p>Consider the surveys data and sub-setting observations that only occurred from 1985 onwards. It’s fairly natural to say <em>“filter the survey where the year variable is equal or greater than 1985”</em>. And indeed this is how we use <code>filter</code> as a verb.</p>
<p>In the code below, we give the filter function two arguments. The first is the data frame, the second is the variable and condition on which we wish to filter.</p>
<p>(Note that we aren’t assigning the output to an object here, so we can see it.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Filter observations that only occurred from 1985 onwards</span>
 <span class="kw">filter</span>(surveys, year &gt;=<span class="st"> </span><span class="dv">1985</span>)</code></pre></div>
<pre><code>#&gt; # A tibble: 25,290 × 13
#&gt;    record_id month   day  year plot_id species_id   sex hindfoot_length
#&gt;        &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;      &lt;chr&gt; &lt;chr&gt;           &lt;int&gt;
#&gt; 1      10606     7    24  1985       2         NL     F              30
#&gt; 2      10617     7    24  1985       2         NL     M              32
#&gt; 3      10627     7    24  1985       2         NL     F              32
#&gt; 4      10720     8    20  1985       2         NL     F              31
#&gt; 5      10923    10    13  1985       2         NL     F              31
#&gt; 6      10949    10    13  1985       2         NL     F              33
#&gt; 7      11215    12     8  1985       2         NL     F              32
#&gt; 8      11329     3     9  1986       2         NL     M              34
#&gt; 9      11496     5    11  1986       2         NL     F              31
#&gt; 10     11498     5    11  1986       2         NL     F              31
#&gt; # ... with 25,280 more rows, and 5 more variables: weight &lt;int&gt;,
#&gt; #   genus &lt;chr&gt;, species &lt;chr&gt;, taxa &lt;chr&gt;, plot_type &lt;chr&gt;</code></pre>
<p>We could even do this for a specific date and species (assuming we know there was an observation), using values for day, month, year and species.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Filter observations that only occurred on the 9th of March 1986</span>
 <span class="kw">filter</span>(surveys, month ==<span class="st"> </span><span class="dv">3</span>, day ==<span class="st"> </span><span class="dv">9</span>, year ==<span class="st"> </span><span class="dv">1986</span>, species_id ==<span class="st"> &quot;NL&quot;</span>)</code></pre></div>
<pre><code>#&gt; # A tibble: 2 × 13
#&gt;   record_id month   day  year plot_id species_id   sex hindfoot_length
#&gt;       &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;      &lt;chr&gt; &lt;chr&gt;           &lt;int&gt;
#&gt; 1     11329     3     9  1986       2         NL     M              34
#&gt; 2     11302     3     9  1986       3         NL     F              30
#&gt; # ... with 5 more variables: weight &lt;int&gt;, genus &lt;chr&gt;, species &lt;chr&gt;,
#&gt; #   taxa &lt;chr&gt;, plot_type &lt;chr&gt;</code></pre>
<p>An alternative way to use <code>filter</code> is to “pipe” the function using <code>%&gt;%</code> which you can think of as using the word <em>“then”</em>. We take our data set <em>then</em> filter it.</p>
<p>This makes more sense when combining several operations, but even with one operation it means we only have to provide the values argument to the filter, like so:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Pipe the filter for observations that only occurred on the 9th of March 1986</span>
surveys %&gt;%<span class="st"> </span><span class="kw">filter</span>(month ==<span class="st"> </span><span class="dv">3</span>, day ==<span class="st"> </span><span class="dv">9</span>, year ==<span class="st"> </span><span class="dv">1986</span>, species_id ==<span class="st"> &quot;NL&quot;</span>)</code></pre></div>
<pre><code>#&gt; # A tibble: 2 × 13
#&gt;   record_id month   day  year plot_id species_id   sex hindfoot_length
#&gt;       &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;      &lt;chr&gt; &lt;chr&gt;           &lt;int&gt;
#&gt; 1     11329     3     9  1986       2         NL     M              34
#&gt; 2     11302     3     9  1986       3         NL     F              30
#&gt; # ... with 5 more variables: weight &lt;int&gt;, genus &lt;chr&gt;, species &lt;chr&gt;,
#&gt; #   taxa &lt;chr&gt;, plot_type &lt;chr&gt;</code></pre>
<p>Armed with this information, let’s filter the data for the period covered in the paper figure, from the start of the surveys in 1977 until the end of 1990.</p>
<blockquote>
<h3 id="challenge">Challenge</h3>
<p>Filter the surveys from 1977 until 1990 and assign the output to <code>surveys_filtered</code></p>
<p>Using the pipe <code>%&gt;%</code> is optional, but recommended.</p>
<p>Ctl+Shift+M is a shortcut to create a pipe.</p>
</blockquote>
<p>To reproduce the analysis in the paper we need to know which which four plots the different treatments were carried out on.</p>
<p>The codes for the twenty four plots are found <a href="https://github.com/weecology/PortalData/blob/master/SiteandMethods/Portal_plot_treatments.csv">here</a>.</p>
<p>To save time, here is a summary of the ones we need, which you can paste into your script:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Control Plots: 2,8,12,22</span>
<span class="co"># Treatment Plots: 3,15,19,21</span>

<span class="co"># Create a vector for the experimental plots</span>
exp_plots &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">8</span>,<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">14</span>,<span class="dv">3</span>,<span class="dv">15</span>,<span class="dv">19</span>,<span class="dv">21</span>)

<span class="co"># Keep only the rows corresponding with the experimental plot_id&#39;s</span>
surveys_filtered &lt;-<span class="st"> </span>surveys_filtered %&gt;%<span class="st"> </span><span class="kw">filter</span>(plot_id %in%<span class="st"> </span>exp_plots)</code></pre></div>
</div>
<div id="selecting-variables" class="section level2">
<h2>Selecting variables</h2>
<p>Selecting columns can be done in various ways. For example, by the column number, the variable name or by range. Check the help function <code>?select</code> for more options.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select the year and plot type columns</span>
surveys %&gt;%<span class="st"> </span><span class="kw">select</span>(year,plot_type)</code></pre></div>
<pre><code>#&gt; # A tibble: 34,786 × 2
#&gt;     year plot_type
#&gt;    &lt;int&gt;     &lt;chr&gt;
#&gt; 1   1977   Control
#&gt; 2   1977   Control
#&gt; 3   1977   Control
#&gt; 4   1977   Control
#&gt; 5   1977   Control
#&gt; 6   1977   Control
#&gt; 7   1977   Control
#&gt; 8   1978   Control
#&gt; 9   1978   Control
#&gt; 10  1978   Control
#&gt; # ... with 34,776 more rows</code></pre>
<p>As we saw earlier, we have thirteen variables in the surveys data, but we don’t need all of them. Specifically we don’t need the sex, the hind-foot length or the weight of the animals. We’re just interested in the population changes over time.</p>
<p>Rather than selecting the columns we want, an alternative is to drop the ones we don’t using a minus sign in front of the variable name, like so:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select everything except sex, hindfoot and weight</span>
surveys_selected &lt;-<span class="st"> </span>surveys_filtered %&gt;%<span class="st"> </span><span class="kw">select</span>(-sex,-hindfoot_length,-weight)

<span class="co"># Check the output</span>
<span class="kw">glimpse</span>(surveys_selected)</code></pre></div>
<pre><code>#&gt; Observations: 6,236
#&gt; Variables: 10
#&gt; $ record_id  &lt;int&gt; 2, 344, 509, 655, 755, 886, 1083, 1087, 1250, 1361,...
#&gt; $ month      &lt;int&gt; 7, 10, 1, 3, 4, 5, 7, 7, 9, 10, 6, 8, 10, 11, 1, 2,...
#&gt; $ day        &lt;int&gt; 16, 18, 8, 11, 8, 18, 8, 8, 4, 8, 23, 14, 26, 23, 1...
#&gt; $ year       &lt;int&gt; 1977, 1977, 1978, 1978, 1978, 1978, 1978, 1978, 197...
#&gt; $ plot_id    &lt;int&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, ...
#&gt; $ species_id &lt;chr&gt; &quot;NL&quot;, &quot;NL&quot;, &quot;NL&quot;, &quot;NL&quot;, &quot;NL&quot;, &quot;NL&quot;, &quot;NL&quot;, &quot;NL&quot;, &quot;NL...
#&gt; $ genus      &lt;chr&gt; &quot;Neotoma&quot;, &quot;Neotoma&quot;, &quot;Neotoma&quot;, &quot;Neotoma&quot;, &quot;Neotom...
#&gt; $ species    &lt;chr&gt; &quot;albigula&quot;, &quot;albigula&quot;, &quot;albigula&quot;, &quot;albigula&quot;, &quot;al...
#&gt; $ taxa       &lt;chr&gt; &quot;Rodent&quot;, &quot;Rodent&quot;, &quot;Rodent&quot;, &quot;Rodent&quot;, &quot;Rodent&quot;, &quot;...
#&gt; $ plot_type  &lt;chr&gt; &quot;Long-term Krat Exclosure&quot;, &quot;Long-term Krat Exclosu...</code></pre>
</div>
<div id="creating-new-variables" class="section level2">
<h2>Creating new variables</h2>
<p>Often we need to create new variables that are functions of existing columns. For example, in the survey data there are forty species, of which we are only interested in eight. Moreover, we are interested in comparing the three Kangaroo Rat species with the five smaller granivores, so it would be useful to have a variable the categorised the rodents as either “Kangaroo Rat” or “Carnivore”.</p>
<p>We could do this using <code>mutate</code> to create a <code>rodent_type</code> variable that is a function of the <code>species_id</code> column.</p>
<p>This is a little tricky, but the steps are as follows:</p>
<ol style="list-style-type: decimal">
<li>Create character vectors corresponding with the <code>species_id</code>’s we are interested in. Here they are called: <code>rodents</code> and <code>krats</code>.</li>
<li>Filter for the eight rodents of interest, using our <code>rodents</code> vector.</li>
<li>Then create a new <code>rodent_type</code> column using <code>species_id</code> such that if the <code>species_id</code> matches a value in <code>krats</code> the value is <code>&quot;Kangeroo Rat&quot;</code> and if it doesn’t match, then the value of <code>rodent_type</code> is <code>&quot;Granivore&quot;</code>.</li>
</ol>
<p>The codes associated with the forty species in the survey data are found <a href="https://github.com/weecology/PortalData/blob/master/Rodents/Portal_rodent_species.csv">here</a>, but to save time the relevant codes are shown below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Kangeroo Rats:</span>
<span class="co"># DM    Dipodomys merriami          Rodent  Merriam&#39;s kangaroo rat</span>
<span class="co"># DO    Dipodomys ordii             Rodent  Ord&#39;s kangaroo rat</span>
<span class="co"># DS    Dipodomys spectabilis       Rodent  Banner-tailed kangaroo rat</span>

<span class="co"># Granivores:</span>
<span class="co"># PP    Chaetodipus penicillatus    Rodent  Desert pocket mouse</span>
<span class="co"># PF    Perognathus flavus          Rodent  Silky pocket mouse</span>
<span class="co"># PE    Peromyscus eremicus         Rodent  Cactus mouse</span>
<span class="co"># PM    Peromyscus maniculatus      Rodent  Deer Mouse</span>
<span class="co"># RM    Reithrodontomys megalotis   Rodent  Western harvest mouse</span>

<span class="co"># Create a character vector for rodents</span>
rodents &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;DM&quot;</span>,<span class="st">&quot;DO&quot;</span>,<span class="st">&quot;DS&quot;</span>,<span class="st">&quot;PP&quot;</span>,<span class="st">&quot;PF&quot;</span>,<span class="st">&quot;PE&quot;</span>,<span class="st">&quot;PM&quot;</span>,<span class="st">&quot;RM&quot;</span>)

<span class="co"># Create a character vector for Kangeroo Rats by subsetting the first</span>
<span class="co"># three elements of rodents</span>
krats &lt;-<span class="st"> </span>rodents[<span class="dv">1</span>:<span class="dv">3</span>]

<span class="co"># Mutate surveys_selected</span>
surveys_mutate &lt;-<span class="st"> </span>surveys_selected %&gt;%
<span class="st">  </span><span class="co"># Filter for observations only for the eight rodents species.</span>
<span class="st">  </span><span class="kw">filter</span>(species_id %in%<span class="st"> </span>rodents) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="co"># Create a new variable called rodent_type as a function of species_id</span>
<span class="st">  </span><span class="co"># we use the if_else() function to test whether the species_id corresponds</span>
<span class="st">  </span><span class="co"># with a Kangeroo rat or a Granivore</span>
<span class="st">  </span><span class="co"># The first arguement to if_else is the conditon: if species_id is in krats.</span>
<span class="st">  </span><span class="co"># The second arguement is the value of rodent_type if the condition is true,</span>
<span class="st">  </span><span class="co"># in this case &quot;Kangeroo rat&quot;</span>
<span class="st">  </span><span class="co"># The third arguement is the value if the condition is false,</span>
<span class="st">  </span><span class="co"># in this case &quot;Granivore&quot;</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rodent_type =</span> <span class="kw">if_else</span>(species_id %in%<span class="st"> </span>krats, <span class="st">&quot;Kangeroo Rat&quot;</span>,
                               <span class="st">&quot;Granivore&quot;</span>))

<span class="co"># Check the output using a summary pipe, we should have 8 species of 2 types</span>
surveys_mutate %&gt;%<span class="st"> </span><span class="kw">group_by</span>(species_id,rodent_type) %&gt;%<span class="st"> </span><span class="kw">summarise</span>()</code></pre></div>
<pre><code>#&gt; Source: local data frame [8 x 2]
#&gt; Groups: species_id [?]
#&gt; 
#&gt;   species_id  rodent_type
#&gt;        &lt;chr&gt;        &lt;chr&gt;
#&gt; 1         DM Kangeroo Rat
#&gt; 2         DO Kangeroo Rat
#&gt; 3         DS Kangeroo Rat
#&gt; 4         PE    Granivore
#&gt; 5         PF    Granivore
#&gt; 6         PM    Granivore
#&gt; 7         PP    Granivore
#&gt; 8         RM    Granivore</code></pre>
<p>We’ll come back to <code>group_by()</code> and <code>summarise()</code> very shortly.</p>
<p>Secondly it would be much more convenient to have a single <code>date</code> variable, and we can make one as a function of the <code>day</code>,<code>month</code> and <code>year</code> variables using another tidyverse package called <code>lubridate</code>.</p>
<p>Don’t worry to much about the details of the code, it’s the concept that matters.</p>
<p>We call the <code>lubridate</code> function <code>dmy()</code> explicitly by using the package name followed by two colons. This in turn uses the <code>sprintf()</code> function to parse the column variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Mutate surveys_selected to create a Date column from the day,month and year</span>
<span class="co"># variables</span>
surveys_mutated &lt;-<span class="st"> </span>surveys_mutate %&gt;%
<span class="st">  </span><span class="co"># Convert day, month and year using lubridate</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> lubridate::<span class="kw">dmy</span>(<span class="kw">sprintf</span>(<span class="st">&#39;%02d%02d%04d&#39;</span>, day, month, year)))

<span class="co"># Check the output</span>
<span class="kw">glimpse</span>(surveys_mutated)</code></pre></div>
<pre><code>#&gt; Observations: 4,795
#&gt; Variables: 12
#&gt; $ record_id   &lt;int&gt; 5, 13, 63, 221, 303, 315, 1279, 2341, 2462, 3013, ...
#&gt; $ month       &lt;int&gt; 7, 7, 8, 9, 10, 10, 9, 1, 2, 5, 11, 11, 1, 1, 3, 3...
#&gt; $ day         &lt;int&gt; 16, 16, 19, 13, 17, 17, 4, 16, 25, 25, 9, 9, 12, 1...
#&gt; $ year        &lt;int&gt; 1977, 1977, 1977, 1977, 1977, 1977, 1978, 1980, 19...
#&gt; $ plot_id     &lt;int&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,...
#&gt; $ species_id  &lt;chr&gt; &quot;DM&quot;, &quot;DM&quot;, &quot;DM&quot;, &quot;DM&quot;, &quot;DM&quot;, &quot;DM&quot;, &quot;DM&quot;, &quot;DM&quot;, &quot;D...
#&gt; $ genus       &lt;chr&gt; &quot;Dipodomys&quot;, &quot;Dipodomys&quot;, &quot;Dipodomys&quot;, &quot;Dipodomys&quot;...
#&gt; $ species     &lt;chr&gt; &quot;merriami&quot;, &quot;merriami&quot;, &quot;merriami&quot;, &quot;merriami&quot;, &quot;m...
#&gt; $ taxa        &lt;chr&gt; &quot;Rodent&quot;, &quot;Rodent&quot;, &quot;Rodent&quot;, &quot;Rodent&quot;, &quot;Rodent&quot;, ...
#&gt; $ plot_type   &lt;chr&gt; &quot;Long-term Krat Exclosure&quot;, &quot;Long-term Krat Exclos...
#&gt; $ rodent_type &lt;chr&gt; &quot;Kangeroo Rat&quot;, &quot;Kangeroo Rat&quot;, &quot;Kangeroo Rat&quot;, &quot;K...
#&gt; $ date        &lt;date&gt; 1977-07-16, 1977-07-16, 1977-08-19, 1977-09-13, 1...</code></pre>
<blockquote>
<h3 id="challenge-1">Challenge</h3>
<p>Create a data frame called <code>surveys_kg</code> with a new variable that converts the the original data frame <code>surveys</code> <code>weight</code> variable to kilograms, call the new variable <code>weight_kg</code>.</p>
<p><code>weight</code> is in grams, so you need to divide by 1000 to convert to kg. Missing values can be removed using the <code>filter()</code> and <code>is.na()</code> functions like so: <code>filter(!is.na(weight))</code>. We need <code>!</code> to make it “is not a NA”.</p>
</blockquote>
</div>
<div id="putting-it-all-together" class="section level2">
<h2>Putting it all together</h2>
<p>Rather than doing each of these steps individually, we could pipe these four operations together to create our <code>surveys_subset</code> data frame.</p>
<p>Note here, we’ve added another variable called <code>quarter</code> which calculates the three monthly date period. This is what they plotted in the paper, which is then helpful for comparing our plot to the published one.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">surveys_subset &lt;-<span class="st"> </span>surveys %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="co"># Filter observations from 1977 to 1990, for the 3 K-rats and 5 granivores, </span>
<span class="st">  </span><span class="co"># and for the 4 experimental plots</span>
<span class="st">  </span><span class="kw">filter</span>(year &lt;=<span class="st"> </span><span class="dv">1990</span>,                    
         species_id %in%<span class="st"> </span>rodents,         
         plot_id %in%<span class="st"> </span>exp_plots) %&gt;%<span class="st">      </span>
<span class="st">  </span><span class="co"># Make variable to indicate whether species is K-rat or Granivore</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rodent_type =</span> <span class="kw">if_else</span>(species_id %in%<span class="st"> </span>krats, <span class="st">&quot;Kangeroo Rat&quot;</span>,
                               <span class="st">&quot;Granivore&quot;</span>),
         <span class="co"># Make combined date variable</span>
         <span class="dt">date =</span> lubridate::<span class="kw">dmy</span>(<span class="kw">sprintf</span>(<span class="st">&#39;%02d%02d%04d&#39;</span>, 
                                       day, month, year)),
  <span class="co"># Add the quartley period</span>
  <span class="dt">quarter =</span> lubridate::<span class="kw">quarter</span>(date,<span class="dt">with_year =</span> <span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="co"># Drop unwanted variables</span>
<span class="st">  </span><span class="kw">select</span>(-sex,-hindfoot_length,-weight)</code></pre></div>
</div>
<div id="grouped-summaries" class="section level2">
<h2>Grouped summaries</h2>
<p>The last verb we’ll consider is <code>summarise()</code>, which collapses a data frame into a single row. For example, we could use it to find the average weight of all the animals surveyed in the original data frame using <code>mean()</code>. (Here the <code>na.rm = TRUE</code> argument is given to remove missing values from the data, otherwise R would return <code>NA</code> when trying to average.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">surveys %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">average_weight =</span> <span class="kw">mean</span>(weight,<span class="dt">na.rm=</span><span class="ot">TRUE</span>))</code></pre></div>
<pre><code>#&gt; # A tibble: 1 × 1
#&gt;   average_weight
#&gt;            &lt;dbl&gt;
#&gt; 1       42.67243</code></pre>
<p><code>summarise()</code> is only really useful when paired with <code>group_by()</code> which defines the variables upon which we operate upon.</p>
<p>In the previous section we used this pairing to check when the species were correctly assigned their rodent type. We first grouped <code>species_id</code> and <code>rodent_type</code> together and then used <code>summarise()</code> without any arguments to show a summary of these two variables only.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Check the output using a summary pipe, we should have 8 species of 2 types</span>
surveys_mutate %&gt;%<span class="st"> </span><span class="kw">group_by</span>(species_id,rodent_type) %&gt;%<span class="st"> </span><span class="kw">summarise</span>()</code></pre></div>
<pre><code>#&gt; Source: local data frame [8 x 2]
#&gt; Groups: species_id [?]
#&gt; 
#&gt;   species_id  rodent_type
#&gt;        &lt;chr&gt;        &lt;chr&gt;
#&gt; 1         DM Kangeroo Rat
#&gt; 2         DO Kangeroo Rat
#&gt; 3         DS Kangeroo Rat
#&gt; 4         PE    Granivore
#&gt; 5         PF    Granivore
#&gt; 6         PM    Granivore
#&gt; 7         PP    Granivore
#&gt; 8         RM    Granivore</code></pre>
<p>Let’s re-cap what we’ve done so far, and remind ourselves of the question we’re trying to answer:</p>
<p><em>Q: Is there evidence that kangaroo rats compete directly with four other granivore rodent species?</em></p>
<p>The evidence we are examining is the monthly populations of 8 species surveyed in four plots over a period of about 13 years. The initial dataset contains data about 40 species in 20 plots measuring 13 variables over 25 years.</p>
<p>At this point we have:</p>
<ul>
<li>Filtered the observations for the time period of interest, and for the species and plots of interest.</li>
<li>We’ve created new variables for the rodent type, the date, and the year quarter</li>
<li>We’ve selected only the variables we need to answer the question.</li>
</ul>
<p>This reduces the dataset from around 35,000 observations of 13 variables to around 5,000 observations of 13 variables. We dropped three of the original variables and create three new variables.</p>
<p>We could start plotting the data, but it would be useful to summarise this a bit more. Concretely, we’d like to summarise the kangaroo rat and granivore populations on a monthly or quarterly basis. Or by genus.</p>
<p>This is where grouped summaries are very useful.</p>
<p>Grouping simply means grouping the variables of interest that we want to operate on, here they are the <code>rodent_type</code> (kangaroo rat and granivore), the <code>quarter</code> (the time period) and the <code>plot_type</code> (kangaroo rat exclusion or control). The summary we would like is the number of captures for each group e.g. number of captures of kangaroo rats for the first quarter of 1980 in the control plots. As each row in the table corresponds with a capture, we just need to count the number of rows in each group. We can do this using the count function <code>n()</code> in conjunction with summarise. This creates a new variable, a column containing the number of rows counted per group, which we’ll call captures. <code>captures</code>.</p>
<p>Here we have the additional issue that the grouping by quarter groups three months worth of captures, so to get the quarterly average number of captures we divide the number of rows counted by three.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Summarise the data by rodent type, quarterly survey and plot type</span>
by_quarter &lt;-<span class="st"> </span>surveys_subset %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(rodent_type,quarter,plot_type) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">captures =</span> <span class="kw">n</span>()/<span class="dv">3</span>) 

<span class="kw">glimpse</span>(by_quarter)</code></pre></div>
<pre><code>#&gt; Observations: 185
#&gt; Variables: 4
#&gt; $ rodent_type &lt;chr&gt; &quot;Granivore&quot;, &quot;Granivore&quot;, &quot;Granivore&quot;, &quot;Granivore&quot;...
#&gt; $ quarter     &lt;dbl&gt; 1977.3, 1977.3, 1977.4, 1977.4, 1978.1, 1978.2, 19...
#&gt; $ plot_type   &lt;chr&gt; &quot;Control&quot;, &quot;Long-term Krat Exclosure&quot;, &quot;Control&quot;, ...
#&gt; $ captures    &lt;dbl&gt; 2.3333333, 0.6666667, 1.3333333, 1.0000000, 1.0000...</code></pre>
<p>We have now transformed the dataset from a 35,000 by 13 table to the 185 by 4 table that we need for re-creating the plot shown in the paper.</p>
<p>But, this is not the only way to look at the data, so we’ll keep the unsummarised subset too. We could export the subset for sharing, but generally it’s better to share the raw data (if it’s not too large) and a script containing the code that will reproduce your transformations. Raw data is the form you received it in, it doesn’t necessarily mean that the data hasn’t been manipulated upstream.</p>
<blockquote>
<h3 id="challenge-2">Challenge</h3>
<p>Create a summary of <code>surveys_subset</code> called <code>by_month_genus</code> grouped by <code>genus</code> , <code>date</code> and <code>plot_type</code>, and summarised using <code>summarise(n())</code>.</p>
<p>There are five genus, three kangeroo rats in the Dipodomys genus, and the granivores make up the other four genus)</p>
</blockquote>
</div>

<hr/>

<p><a href="http://datacarpentry.org/">Data Carpentry</a>, 2017. <br/>
  <a href="LICENSE.html">License</a>. Questions?  Feedback?
  Please <a href="https://github.com/datacarpentry/R-ecology-lesson/issues/new">file
    an issue on GitHub</a>. <br/>
  On Twitter: <a href="https://twitter.com/datacarpentry">@datacarpentry</a></p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
